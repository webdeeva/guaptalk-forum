(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[52185,74566],{12236:(d,m,s)=>{"use strict";var p,f;p=[s(49897),s(29930)],f=function(v,S){const i={};i.init=function(t,e){const n=t.find(".draft-icon"),a=t.attr("data-uuid");function o(){$(`[component="composer"][data-uuid="${a}"]`).length&&(e.save_id||(e.save_id=utils.generateSaveId(app.user.uid)),i.addToDraftList("available",e.save_id),i.addToDraftList("open",e.save_id),y(t,n,e))}t.on("keyup","textarea, input.handle, input.title",utils.debounce(o,1e3)),t.on("click",'input[type="checkbox"]',utils.debounce(o,1e3)),t.on("click",'[component="category/list"] [data-cid]',utils.debounce(o,1e3)),t.on("itemAdded",".tags",utils.debounce(o,1e3)),t.on("thumb.uploaded",o),n.on("animationend",function(){$(this).toggleClass("active",!1)}),$(window).on("unload",function(){const r=i.getList("open");r.length&&r.forEach(c=>i.removeFromDraftList("open",c))}),i.migrateGuest(),i.migrateThumbs(...arguments)};function g(t){return parseInt(t,10)>0?localStorage:sessionStorage}i.get=function(t){if(!t)return null;const e=t.split(":")[1],n=g(e);try{const a=n.getItem(t),o=JSON.parse(a)||null;if(!o)throw new Error(`can't parse draft json for ${t}`);return o.save_id=t,o.timestamp&&(o.timestampISO=utils.toISOString(o.timestamp)),$(window).trigger("action:composer.drafts.get",{save_id:t,draft:o,storage:n}),o}catch{return console.warn(`[composer/drafts] Could not get draft ${t}, removing`),i.removeFromDraftList("available"),i.removeFromDraftList("open"),null}};function y(t,e,n){if(u(app.user.uid?"localStorage":"sessionStorage")&&n&&n.save_id&&t.length){const a=t.find("input.title"),o=a&&a.length&&a.val(),r=t.find("textarea").val(),c=g(app.user.uid);if(r.length||o&&o.length){const l={save_id:n.save_id,action:n.action,text:r,uuid:t.attr("data-uuid"),timestamp:Date.now()};if(n.action==="topics.post"){const E=t.find("input.tags").val();l.tags=E,l.title=o,l.cid=n.cid}else n.action==="posts.reply"?(l.title=n.title,l.tid=n.tid,l.toPid=n.toPid):n.action==="posts.edit"&&(l.pid=n.pid,l.title=o||n.title);app.user.uid||(l.handle=t.find("input.handle").val()),c.setItem(n.save_id,JSON.stringify(l)),$(window).trigger("action:composer.drafts.save",{storage:c,postData:n,postContainer:t}),e.toggleClass("active",!0)}else i.removeDraft(n.save_id)}}i.removeDraft=function(t){if(!t)return;i.removeFromDraftList("available",t),i.removeFromDraftList("open",t);const e=t.split(":")[1],n=g(e);n.removeItem(t),$(window).trigger("action:composer.drafts.remove",{storage:n,save_id:t})},i.getList=function(t){try{const e=localStorage.getItem(`drafts:${t}`);return JSON.parse(e)||[]}catch{return console.warn("[composer/drafts] Could not read list of available drafts"),[]}},i.addToDraftList=function(t,e){if(!u(app.user.uid?"localStorage":"sessionStorage")||!e)return;const n=i.getList(t);n.includes(e)||(n.push(e),localStorage.setItem("drafts:"+t,JSON.stringify(n)))},i.removeFromDraftList=function(t,e){if(!u(app.user.uid?"localStorage":"sessionStorage")||!e)return;const n=i.getList(t);n.includes(e)&&(n.splice(n.indexOf(e),1),localStorage.setItem("drafts:"+t,JSON.stringify(n)))},i.migrateGuest=function(){if(u("localStorage")&&app.user.uid){const t=/^composer:\d+:\d$/,e=Object.keys(sessionStorage).filter(function(o){return t.test(o)}),n=new Set([]),a=e.map(function(o){const r=o.split(":");return r[1]=app.user.uid,n.add(r.join(":")),r.join(":")});return e.forEach(function(o,r){localStorage.setItem(a[r],sessionStorage.getItem(o)),sessionStorage.removeItem(o)}),n.forEach(function(o){i.addToDraftList("available",o)}),n}},i.migrateThumbs=function(t,e){if(!app.uid)return;const n=t.attr("data-uuid"),a=i.get(e.save_id);a&&a.uuid&&v.put(`/topics/${a.uuid}/thumbs`,{tid:n}).then(()=>{Promise.all([s.e(20056),s.e(23662),s.e(65285),s.e(40559),s.e(449),s.e(5785),s.e(36159)]).then(function(){var o=[s(71431)];(function(r){r.updateThumbCount(n,t)}).apply(null,o)}).catch(s.oe)})},i.listAvailable=function(){return i.getList("available").map(i.get).filter(Boolean)},i.getAvailableCount=function(){return i.listAvailable().length},i.open=function(t){if(!t)return;const e=i.get(t);h(t,e)},i.loadOpen=function(){if(ajaxify.data.template.login||ajaxify.data.template.register||config.hasOwnProperty("openDraftsOnPageLoad")&&!config.openDraftsOnPageLoad)return;const t=i.getList("available"),e=i.getList("open");t.length&&t.forEach(function(n){if(!n||e.includes(n))return;const a=i.get(n);if(!a||!a.text&&!a.title){i.removeFromDraftList("available",n),i.removeFromDraftList("open",n);return}h(n,a)})};function h(t,e){const a=t.split(":")[1];parseInt(app.user.uid,10)===parseInt(a,10)&&Promise.all([s.e(20056),s.e(23662),s.e(65285),s.e(40559),s.e(449),s.e(5785),s.e(36159)]).then(function(){var o=[s(71431)];(function(r){e.action==="topics.post"?r.newTopic({save_id:e.save_id,cid:e.cid,handle:app.user&&app.user.uid?void 0:utils.escapeHTML(e.handle),title:utils.escapeHTML(e.title),body:e.text,tags:String(e.tags||"").split(",")}):e.action==="posts.reply"?v.get("/topics/"+e.tid,{},function(c,l){if(c)return S.error(c);r.newReply({save_id:e.save_id,tid:e.tid,toPid:e.toPid,title:l.title,body:e.text})}):e.action==="posts.edit"&&r.editPost({save_id:e.save_id,pid:e.pid,title:e.title?utils.escapeHTML(e.title):void 0,body:e.text})}).apply(null,o)}).catch(s.oe)}function u(t){var e;try{e=window[t];var n="__storage_test__";return e.setItem(n,n),e.removeItem(n),!0}catch(a){return a instanceof DOMException&&(a.code===22||a.code===1014||a.name==="QuotaExceededError"||a.name==="NS_ERROR_DOM_QUOTA_REACHED")&&e&&e.length!==0}}return i}.apply(m,p),f!==void 0&&(d.exports=f)},74566:(d,m,s)=>{d.exports=s(12236)}}]);
